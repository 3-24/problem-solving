name: C++ Test and Format

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install Clang
        run: sudo apt-get install -y clang

      - name: Get the modified C++ file
        id: git-diff
        run: |
          problem=$(git diff --name-only --diff-filter=d origin/main...HEAD | grep '.cpp' | sed 's/.cpp//g')
          if [[ -n "$problem" ]]; then
            echo "problem=$(problem)" >> $GITHUB_ENV
          else
            echo "No C++ file to process"
            exit 0
          fi

      - name: Compile
        run: |
          clang++ -std=c++20 -fsanitize=address -o "${{ env.problem }}" "${{ env.problem }}".cpp

      - name: Run test and check results
        id: test
        run: |
          result=$(python3 test.py "${{ env.problem }})"
          echo "$result"
          if [[ $result == "FAIL" ]]; then
            echo "Tests failed"
            exit 1
          else
            echo "All tests passed"
          fi