name: C++ Test

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install Clang
        run: sudo apt-get install -y clang

      - name: Test C++ file
        id: git-diff
        run: |
          problem=$(git diff-tree --no-commit-id --name-only -r HEAD | grep '.cpp' | sed 's/.cpp//g' | xargs)
          echo $problem
          if [[ -n "$problem" ]]; then
            clang++ -std=c++20 -fsanitize=address -o "$problem" "$problem".cpp
            result=$(python3 test.py $problem)
            echo "$result"
            if [[ $result == "FAIL" ]]; then
              echo "Tests failed"
              exit 1
            else
              echo "All tests passed"
            fi
          else
            # Success github actions early
            echo "No C++ file modified"
            exit 0
          fi